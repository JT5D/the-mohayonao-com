(function(){$(function(){"use strict";var e,t,n,r,i,s,o,u,a,f,l;i=480,r=360,u=(l=window.URL||window.webkitURL)!=null?l.createObjectURL:void 0,a=window.webkitRequestAnimationFrame,o=null,$(window).on("dragover",function(){return!1}),$(window).on("drop",function(e){return o&&u&&o.setFiles(e.originalEvent.dataTransfer.files),!1}),f=function(){var e;return e=$("#container"),function(){return e.height(e.width()*.75|0)}}(),$(window).on("resize",f),f();if(!webkitAudioContext)return;if(!u)return;if(!a)return;return $("#full-screen").on("click",function(){return o.fullScreen()}),$("#play").on("click",function(){return o.play()}),$("#pause").on("click",function(){return o.pause()}),$("#processing").on("change",function(){return o.setProcessing(!!$(this).attr("checked"))}),$("#loop").on("change",function(){return o.loop=!!$(this).attr("checked")}),$("#currentTime").on("change",function(){return o.setCurrentTime(($(this).val()|0)/1e4)}),e=function(){function e(){this.processors=[],this.files=[],this.filesIndex=0,this.video=null,this.loop=!1,this.isPlaying=!1}return e.prototype.setFiles=function(e,t){return this.pause(),this.files=e,this.filesIndex=0,this.video=null,this.next()},e.prototype.next=function(e){var t,n,r,i=this;typeof e=="number"&&e>=0&&(this.filesIndex=e);if(this.filesIndex>=this.files.length){this.video&&this.loop&&this.isPlaying&&this.next(0);return}return t=this.files[this.filesIndex++],n=t.type.substr(0,5),r=document.createElement("video"),n==="video"&&r.canPlayType(t.type)?($(r).on("loadeddata",function(){return r.currentTime=0,r.muted=!0,i.processors.forEach(function(e){return e.init(r)}),i.play()}),$(r).on("seeked",function(){if(r.paused)return i.processors.forEach(function(e){return e.process()})}),$(r).on("ended",function(){return i.next()}),r.type=t.type,r.src=u(t),this.video=r):this.next()},e.prototype.addProcessor=function(e){return this.processors.push(e)},e.prototype.addSubProcessor=function(e){return this.processors.forEach(function(t){return t.subProcessor=e})},e.prototype.setCurrentTime=function(e){var t;return(t=this.video)!=null?t.currentTime=this.video.duration*e:void 0},e.prototype.setProcessing=function(e){return this.processors.forEach(function(t){return t.processing=e})},e.prototype.fullScreen=function(){if(!this.video.paused)return this.processors.forEach(function(e){return typeof e.fullScreen=="function"?e.fullScreen():void 0})},e.prototype.play=function(){var e;return this.isPlaying=!0,(e=this.video)!=null?e.play():void 0},e.prototype.pause=function(){var e;return this.isPlaying=!1,(e=this.video)!=null?e.pause():void 0},e}(),s=function(){function e(e){this.subProcessor=null,this.target=e,this.context=e.getContext("2d"),this.canvas=document.createElement("canvas"),this.canvas.context=this.canvas.getContext("2d"),this.target.width=this.canvas.width=i,this.target.height=this.canvas.height=r,this.processing=!0,this.prevProcess=0}return e.prototype.init=function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p=this;return t=$(e),t.on("play",function(){return p.play()}),t.on("pause",function(){return p.pause()}),t.on("timeupdate",function(){return $("#currentTime").val(e.currentTime/e.duration*1e4)}),a=[e.videoWidth,e.videoHeight],o=a[0],s=a[1],f=[this.canvas.width,this.canvas.height],r=f[0],n=f[1],o>s?(i=r*(s/o),l=[0,(n-i)*.5,r,i],this.dx=l[0],this.dy=l[1],this.dw=l[2],this.dh=l[3]):(u=n*(o/s),c=[(r-u)*.5,0,u,n],this.dx=c[0],this.dy=c[1],this.dw=c[2],this.dh=c[3]),h=[0,0,o,s],this.sx=h[0],this.sy=h[1],this.sw=h[2],this.sh=h[3],this.canvas.context.clearRect(0,0,r,n),this.video=e},e.prototype.play=function(){var e=this;return this.isPaused=!1,a(function(){return e.process()})},e.prototype.pause=function(){return this.isPaused=!0},e.prototype.process=function(){var e,t,n,r,i=this;n=+(new Date),n-this.prevProcess>60&&(this.prevProcess=n,this.canvas.context.drawImage(this.video,this.sx,this.sy,this.sw,this.sh,this.dx,this.dy,this.dw,this.dh),r=this.canvas.toDataURL("image/jpeg"),this.processing&&this.subProcessor&&(e=this.subProcessor.videoProcess(atob(r.replace(/^.*,/,""))),r=["data:image/jpeg;base64,",btoa(e.replace(/[\u0100-\uffff]/g,function(e){return String.fromCharCode(e.charCodeAt(0)&255)}))].join("")),t=new Image,t.onload=function(){return i.context.drawImage(t,0,0)},t.src=r);if(!this.isPaused)return a(function(){return i.process()})},e.prototype.fullScreen=function(){return this.target.webkitRequestFullScreen()},e}(),t=function(){function e(e){this.subProcessor=null,this.target=e,this.stream=new Float32Array(1024),this.processing=!0,this.isPlaying=!1}return e.prototype.init=function(e){var t,n,r,i,s,o=this;return this.isPlaying&&this.pause(),t=$(e),t.on("play",function(){return o.play()}),t.on("pause",function(){return o.pause()}),r=this.target.createMediaElementSource(e),n=this.target.createGainNode(),n.gain.value=.4,i=this.target.createJavaScriptNode(1024,2,2),i.onaudioprocess=this.process.bind(this),r.connect(n),r.connect(i),s=[i,n,e],this.node=s[0],this.gain=s[1],this.video=s[2],s},e.prototype.play=function(){return this.gain.connect(this.target.destination),this.node.connect(this.target.destination),this.isPlaying=!0},e.prototype.pause=function(){return this.node.disconnect(),this.gain.disconnect(),this.isPlaying=!1},e.prototype.process=function(e){var t,n,r,i,s,o,u,a,f;if(!e)return;i=this.stream,t=e.inputBuffer.getChannelData(0),n=e.inputBuffer.getChannelData(1);for(r=s=0,u=t.length;0<=u?s<u:s>u;r=0<=u?++s:--s)i[r]=(t[r]+n[r])*.5;this.processing&&this.subProcessor&&(i=this.subProcessor.audioProcess(i)),t=e.outputBuffer.getChannelData(0),n=e.outputBuffer.getChannelData(1),f=[];for(r=o=0,a=t.length;0<=a?o<a:o>a;r=0<=a?++o:--o)f.push(t[r]=n[r]=i[r]);return f},e}(),n=function(){function e(){this.mode=0,this.level=.2}return e.prototype.videoProcess=function(){var e,t,n;return e=0,t=function(e,t){return Math.random()*(t-e+1)+1|0},n=new Uint8Array(function(){var n,r;r=[];for(e=n=0;n<4096;e=++n)r.push(t(0,9));return r}()),function(t){return this.mode===3?t.replace(/0/ig,function(t){return String.fromCharCode(48+n[e++&4095])}):Math.random()<.5?t.replace(/0/ig,function(t){return Math.random()<.02?String.fromCharCode(48+n[e++&4095]):t}):t}}(),e.prototype.audioProcess=function(e){var t,n,r,i;this.mode===0&&Math.random()<this.level&&(this.mode=1),this.mode===1&&(this.mode=2,this.glitchbuffer=[],this.glitchbufferLength=(Math.random()*4|0)+1),this.mode===2&&(this.glitchbuffer.push(new Float32Array(e)),this.glitchbuffer.length===this.glitchbufferLength&&(this.mode=3,this.glitchindex=0,this.glitchindexMax=(Math.random()*18|0)*2+2));if(this.mode===3){t=this.glitchbuffer[this.glitchindex%this.glitchbufferLength];for(n=r=0,i=e.length;0<=i?r<i:r>i;n=0<=i?++r:--r)e[n]=t[n];this.glitchindex+=1,this.glitchindex===this.glitchindexMax&&(this.mode=4)}return this.mode===4&&(this.glitchindex-=1,this.glitchindex===0&&(this.mode=0)),e},e}(),o=new e,o.addProcessor(new s(document.getElementById("preview"))),o.addProcessor(new t(new webkitAudioContext)),o.addSubProcessor(new n)})}).call(this)